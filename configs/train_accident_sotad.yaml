# SO-TAD 事故检测配置文件
# 基于 SO-TAD 论文的配置

GIT_VERSION:

MODE: train_sotad
CONFIG_PATH:
AVAILABLE_GPUS: "0,1,2,3"
DEVICE: cuda
USE_DISTRIBUTED: False
USE_CHECKPOINT: False
CHECKPOINT_LEVEL: 0
VISUALIZE: False

# ==================== 基础配置 ====================
SEED: 42
OUTPUTS_DIR: "outputs/accident_so_tad/"
LOGGING: True

# ==================== 数据集配置 ====================
DATASET_ROOT: "/home/y23_zhanghaoyu/subject/datasets/so-tad"

# SO-TAD 数据集参数（参考论文）
FRAME_NUM: 4           # 每个样本包含的帧数 [f_{t-3}, f_{t-2}, f_{t-1}, f_t]
FRAME_SPACE: 5         # 帧间隔（每隔5帧采样一次）
SAMPLE_SPACE: 3        # 样本间隔（滑动窗口步长）

# 数据增强
SCALES: [480, 512, 544, 576, 608, 640, 672, 704, 736, 768, 800]
NUM_WORKERS: 4
BATCH_SIZE: 4          # 根据你的GPU内存调整
ACCUMULATION_STEPS: 1

# ==================== 模型配置 ====================
# HNCD 配置（特征提取器）
DATASET: AICity22
PRETRAINED_HNCD: "./outputs/hnd_aicity22/checkpoint_8.pth"
FREEZE_FEATURE_EXTRACTOR: true  # 是否冻结特征提取器

# SO-TAD 模型配置
FEATURE_DIM: 256       # 特征维度（HNCD输出）
GAN_CH: 16             # GAN中间通道数
UPSCALE_FACTOR: 4      # 上采样因子（PixelShuffle）
WITH_ENC: True         # 是否使用encoder
REAL_LABEL: 0.9        
FAKE_LABEL: 0.1
NETD_VERSION: rp     # 判别器版本 (original, standard, gap, rp)

# ==================== HNCD 特征提取器配置（必需） ====================
# Backbone
BACKBONE: resnet50
HIDDEN_DIM: 256
FFN_DIM: 2048
NUM_FEATURE_LEVELS: 4
NUM_HEADS: 8
NUM_ENC_POINTS: 4
NUM_DEC_POINTS: 4
NUM_ENC_LAYERS: 6
NUM_DEC_LAYERS: 6
MERGE_DET_TRACK_LAYER: 1
ACTIVATION: ReLU
RETURN_INTER_DEC: True
EXTRA_TRACK_ATTN: False
AUX_LOSS: True
USE_DAB: True
UPDATE_THRESH: 0.5
LONG_MEMORY_LAMBDA: 0.01
NUM_DET_QUERIES: 10
DROPOUT: 0.0

# CDN (Not used for SO-TAD)
NUM_CDN_GROUP: 0
ID_NOISE_RATIO: 0.3
BOX_NOISE_SCALE: 0.4
CDN_K: 5
USE_TINY_NOISE: True
DET_DB:

# ==================== 训练配置 ====================
# 基础训练参数
EPOCHS: 60

# 优化器配置（GAN需要两个优化器）
LR_G: 2.0e-4           # 生成器学习率
LR_D: 2.0e-5           # 判别器学习率
WEIGHT_DECAY: 1.0e-4

# 学习率调度器
LR_SCHEDULER: Cosine   # Cosine or MultiStep
LR_DROP_MILESTONES: [40, 50]
LR_DROP_RATE: 0.1

# 梯度裁剪
CLIP_MAX_NORM: 0.1

# 损失权重
LAMBDA_COS: 1.0        # 余弦相似度损失权重
LAMBDA_ADV: 1.0        # 对抗损失权重


# ==================== 验证配置 ====================
EVAL_INTERVAL: 1             # 每隔多少个epoch验证一次
SAVE_CHECKPOINT_INTERVAL: 1   # 每隔多少个epoch保存一次checkpoint

# ADF测试阈值（用于事故检测）
ADF_THRESHOLD: 0.1     # p-value阈值，>= threshold判定为事故

# ==================== Resume ====================
RESUME:
RESUME_SCHEDULER: False
